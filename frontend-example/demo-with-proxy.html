<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat WebSocket - Demo Completa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

            .header h1 {
                font-size: 32px;
                margin-bottom: 10px;
            }

            .header p {
                opacity: 0.9;
                font-size: 16px;
            }

        .connection-status {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .status-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }

            .status-dot.connected {
                background: #28a745;
            }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 0;
            min-height: 600px;
        }

        .sidebar {
            background: #f8f9fa;
            border-right: 2px solid #dee2e6;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .panel-header {
            background: #667eea;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            font-size: 14px;
        }

        .panel-body {
            padding: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
                font-size: 13px;
                color: #495057;
            }

            .form-group input,
            .form-group textarea {
                width: 100%;
                padding: 10px;
                border: 1px solid #ced4da;
                border-radius: 4px;
                font-size: 14px;
                font-family: inherit;
            }

            .form-group textarea {
                resize: vertical;
                min-height: 80px;
            }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        .btn-primary {
            background: #667eea;
            color: white;
        }

            .btn-primary:hover:not(:disabled) {
                background: #5568d3;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

        .btn-success {
            background: #28a745;
            color: white;
        }

            .btn-success:hover:not(:disabled) {
                background: #218838;
            }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

            .btn-danger:hover:not(:disabled) {
                background: #c82333;
            }

        .chat-area {
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: #6c757d;
        }

        .message-content {
            color: #212529;
            font-size: 14px;
            line-height: 1.5;
        }

        .message-status {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
            font-size: 11px;
            color: #6c757d;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 5px;
        }

        .status-sent {
            background: #fff3cd;
            color: #856404;
        }

        .status-delivered {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-read {
            background: #d4edda;
            color: #155724;
        }

        .send-area {
            padding: 20px;
            background: white;
            border-top: 2px solid #dee2e6;
        }

        .send-form {
            display: flex;
            gap: 10px;
        }

            .send-form input {
                flex: 1;
                padding: 12px;
                border: 1px solid #ced4da;
                border-radius: 6px;
                font-size: 14px;
            }

            .send-form button {
                width: auto;
                padding: 12px 30px;
            }

        .log-container {
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #e9ecef;
        }

            .log-entry:last-child {
                border-bottom: none;
            }

        .log-time {
            color: #6c757d;
            margin-right: 8px;
        }

        .log-info {
            color: #0c5460;
        }

        .log-success {
            color: #155724;
        }

        .log-error {
            color: #721c24;
        }

        .subscriptions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .subscription-badge {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border-radius: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .subscription-badge button {
                width: auto;
                padding: 2px 8px;
                font-size: 10px;
                background: rgba(255,255,255,0.3);
                color: white;
            }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Chat WebSocket - Demo Completa</h1>
            <p>Envie e receba mensagens em tempo real via WebSocket</p>
        </div>

        <div class="connection-status">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Desconectado</span>
            </div>
            <div id="subscriptionsDisplay" class="subscriptions"></div>
        </div>

        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Conex√£o -->
                <div class="panel">
                    <div class="panel-header">üîå Conex√£o</div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label>URL da API</label>
                            <input type="text" id="apiUrl" value="http://localhost:8080" placeholder="http://localhost:8080">
                        </div>
                        <div class="form-group">
                            <label>JWT Token</label>
                            <textarea id="jwtToken" placeholder="Cole seu JWT token aqui"></textarea>
                        </div>
                        <button class="btn-primary" id="connectBtn" onclick="toggleConnection()">
                            Conectar
                        </button>
                    </div>
                </div>

                <!-- Inscri√ß√£o -->
                <div class="panel">
                    <div class="panel-header">üì¨ Inscrever em Conversa</div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label>Conversation ID</label>
                            <input type="text" id="conversationId" placeholder="ex: conv-123">
                        </div>
                        <button class="btn-success" id="subscribeBtn" onclick="subscribe()" disabled>
                            Inscrever
                        </button>
                    </div>
                </div>

                <!-- Log -->
                <div class="panel">
                    <div class="panel-header">üìù Log de Eventos</div>
                    <div class="panel-body">
                        <div class="log-container" id="logContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area">
                <div class="messages-container" id="messagesContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <p>Conecte-se e inscreva-se em uma conversa para come√ßar</p>
                    </div>
                </div>
                <div class="send-area">
                    <div class="send-form">
                        <input type="text" id="messageInput" placeholder="Digite sua mensagem..." disabled>
                        <button class="btn-primary" id="sendBtn" onclick="sendMessage()" disabled>
                            Enviar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let subscribedConversations = new Set();
        let messages = new Map(); // messageId -> message object
        let currentConversation = null;

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-time">${time}</span>${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');
            const subscribeBtn = document.getElementById('subscribeBtn');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            if (connected) {
                dot.classList.add('connected');
                text.textContent = 'Conectado';
                connectBtn.textContent = 'Desconectar';
                connectBtn.className = 'btn-danger';
                subscribeBtn.disabled = false;
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Desconectado';
                connectBtn.textContent = 'Conectar';
                connectBtn.className = 'btn-primary';
                subscribeBtn.disabled = true;
                messageInput.disabled = true;
                sendBtn.disabled = true;
            }
        }

        function updateSubscriptionsDisplay() {
            const display = document.getElementById('subscriptionsDisplay');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            if (subscribedConversations.size === 0) {
                display.innerHTML = '';
                messageInput.disabled = true;
                sendBtn.disabled = true;
                return;
            }

            display.innerHTML = '';
            subscribedConversations.forEach(convId => {
                const badge = document.createElement('div');
                badge.className = 'subscription-badge';
                badge.innerHTML = `
                        ${convId}
                        <button onclick="unsubscribe('${convId}')">√ó</button>
                    `;
                display.appendChild(badge);
            });

            messageInput.disabled = false;
            sendBtn.disabled = false;
        }

        function toggleConnection() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
                log('Desconectando...', 'info');
            } else {
                connect();
            }
        }

        function connect() {
            const apiUrl = document.getElementById('apiUrl').value;
            const token = document.getElementById('jwtToken').value.trim();

            if (!token) {
                alert('Por favor, insira um JWT token');
                return;
            }

            const wsUrl = apiUrl.replace('http://', 'ws://').replace('https://', 'wss://');
            const url = `${wsUrl}/ws/status?access_token=${encodeURIComponent(token)}`;

            log('Conectando...', 'info');
            ws = new WebSocket(url);

            ws.onopen = () => {
                log('‚úÖ CONECTADO', 'success');
                updateStatus(true);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    log(`Erro ao parsear mensagem: ${error.message}`, 'error');
                }
            };

            ws.onerror = (error) => {
                log(`‚ùå ERRO: ${error.message || 'Erro no WebSocket'}`, 'error');
                console.error('WebSocket error:', error);
            };

            ws.onclose = (event) => {
                log(`‚ùå DESCONECTADO (c√≥digo: ${event.code})`, 'error');
                updateStatus(false);
                subscribedConversations.clear();
                updateSubscriptionsDisplay();
                ws = null;
            };
        }

        function handleWebSocketMessage(data) {
            log(`üì® Recebido: ${data.type}`, 'info');

            if (data.type === 'message.status') {
                handleStatusUpdate(data);
            }
        }

        function handleStatusUpdate(data) {
            const messageId = data.messageId;
            const status = data.status;

            log(`Status atualizado: ${messageId} ‚Üí ${status}`, 'success');

            // Atualizar ou criar mensagem
            if (!messages.has(messageId)) {
                messages.set(messageId, {
                    id: messageId,
                    conversationId: data.conversationId,
                    content: data.content || '(mensagem externa)',
                    status: status,
                    timestamp: new Date(data.timestamp)
                });
            } else {
                const msg = messages.get(messageId);
                msg.status = status;
            }

            renderMessages();
        }

        function subscribe() {
            const convId = document.getElementById('conversationId').value.trim();

            if (!convId) {
                alert('Por favor, insira um Conversation ID');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket n√£o est√° conectado');
                return;
            }

            const message = {
                type: 'subscribe',
                conversationId: convId
            };

            ws.send(JSON.stringify(message));
            subscribedConversations.add(convId);
            currentConversation = convId;
            updateSubscriptionsDisplay();
            log(`‚úÖ Inscrito em: ${convId}`, 'success');
        }

        function unsubscribe(convId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }

            const message = {
                type: 'unsubscribe',
                conversationId: convId
            };

            ws.send(JSON.stringify(message));
            subscribedConversations.delete(convId);
            if (currentConversation === convId) {
                currentConversation = subscribedConversations.values().next().value || null;
            }
            updateSubscriptionsDisplay();
            log(`‚ùå Desinscrito de: ${convId}`, 'info');
        }

        async function sendMessage() {
            const content = document.getElementById('messageInput').value.trim();

            if (!content) {
                alert('Digite uma mensagem');
                return;
            }

            if (!currentConversation) {
                alert('Inscreva-se em uma conversa primeiro');
                return;
            }

            const apiUrl = document.getElementById('apiUrl').value;
            const token = document.getElementById('jwtToken').value.trim();
            const messageId = generateUUID();

            // Adicionar mensagem localmente
            messages.set(messageId, {
                id: messageId,
                conversationId: currentConversation,
                content: content,
                status: 'SENDING',
                timestamp: new Date()
            });
            renderMessages();

            // Enviar via API REST
            try {
                const response = await fetch(`${apiUrl}/api/v1/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messageId: messageId,
                        conversationId: currentConversation,
                        content: content
                    })
                });

                if (response.ok) {
                    log(`‚úÖ Mensagem enviada: ${messageId}`, 'success');
                    document.getElementById('messageInput').value = '';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erro ao enviar: ${error.message}`, 'error');
                messages.delete(messageId);
                renderMessages();
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');

            if (messages.size === 0) {
                container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <p>Nenhuma mensagem ainda. Envie uma mensagem para come√ßar!</p>
                        </div>
                    `;
                return;
            }

            const sortedMessages = Array.from(messages.values())
                .sort((a, b) => a.timestamp - b.timestamp);

            container.innerHTML = '';
            sortedMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                        <div class="message-header">
                            <span><strong>ID:</strong> ${msg.id.substring(0, 8)}...</span>
                            <span><strong>Conversa:</strong> ${msg.conversationId}</span>
                        </div>
                        <div class="message-content">${escapeHtml(msg.content)}</div>
                        <div class="message-status">
                            <strong>Status:</strong>
                            <span class="status-badge status-${msg.status.toLowerCase()}">${msg.status}</span>
                            <span style="margin-left: 10px; color: #6c757d;">
                                ${msg.timestamp.toLocaleTimeString()}
                            </span>
                        </div>
                    `;
                container.appendChild(messageDiv);
            });

            container.scrollTop = container.scrollHeight;
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Permitir enviar com Enter
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // Log inicial
        log('Sistema iniciado. Configure e conecte para come√ßar.', 'info');
    </script>
</body>
</html>