<Window x:Class="Chat.Client.Wpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:Chat.Client.Wpf.ViewModels"
        xmlns:models="clr-namespace:Chat.Client.Wpf.Models"
        xmlns:local="clr-namespace:Chat.Client.Wpf"
        Title="Chat Socket - Avançado" Height="650" Width="1000"
        WindowStartupLocation="CenterScreen">

    <!-- ========== Resources ========== -->
    <Window.Resources>
        <local:UnreadToVisibility x:Key="UnreadToVisibility"/>
        <local:PercentToDouble   x:Key="PercentToDouble"/>
        <local:BoolToBrush       x:Key="BoolToBrush"/>
        <local:BoolToAlignment   x:Key="BoolToAlignment"/>
        <local:BoolToVisibility  x:Key="BoolToVisibility"/>

        <!-- Card de conversa na sidebar -->
        <DataTemplate x:Key="ConversationItemTemplate" DataType="{x:Type models:Conversation}">
            <Grid Margin="6">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel>
                    <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding LastPreview}" Opacity="0.7" TextTrimming="CharacterEllipsis"/>
                </StackPanel>
                <Border Grid.Column="1" Background="#FF3D6DCC" CornerRadius="10" Padding="4,0"
                        Visibility="{Binding Unread, Converter={StaticResource UnreadToVisibility}}">
                    <TextBlock Text="{Binding Unread}" Foreground="White"/>
                </Border>
            </Grid>
        </DataTemplate>
    </Window.Resources>

    <!-- ========== Layout raiz ========== -->
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280"/>   <!-- Sidebar -->
            <ColumnDefinition Width="*"/>     <!-- Conversa -->
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>    <!-- Header -->
            <RowDefinition Height="*"/>       <!-- Corpo -->
            <RowDefinition Height="Auto"/>    <!-- Rodapé -->
        </Grid.RowDefinitions>

        <!-- Header: conexão -->
        <DockPanel Grid.ColumnSpan="2" Grid.Row="0" Margin="8" LastChildFill="False">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" Margin="0,0,8,0">
                <TextBlock Text="Host:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                <TextBox Width="130" Text="{Binding Host}" Margin="0,0,8,0"/>
                <TextBlock Text="Port:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                <TextBox Width="70" Text="{Binding Port}" Margin="0,0,8,0"/>
                <TextBlock Text="User:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                <TextBox Width="120" Text="{Binding Username}" Margin="0,0,8,0"/>
            </StackPanel>
            <Button Content="Conectar" Width="100" Command="{Binding ConnectCommand}"/>
            <Button Content="Listar usuários" Width="120" Margin="8,0,0,0" Command="{Binding ListUsersCommand}"/>
            <TextBlock Text="{Binding Info}" Margin="16,0,0,0" VerticalAlignment="Center"/>
        </DockPanel>

        <!-- ========== Sidebar (coluna 0) ========== -->
        <Grid Grid.Column="0" Grid.Row="1" Margin="8">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Privados -->
            <GroupBox Grid.Row="0" Margin="0,0,0,8">
                <GroupBox.Header>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Privados" FontWeight="Bold" VerticalAlignment="Center"/>
                        <Button Grid.Column="1" Content="＋" Width="24" Height="24" Margin="8,0,0,0"
                                ToolTip="Iniciar conversa privada"
                                Command="{Binding NewDirectCommand}"/>
                    </Grid>
                </GroupBox.Header>

                <ListBox ItemsSource="{Binding Directs}"
         SelectedItem="{Binding SelectedDirect}"
         ItemTemplate="{StaticResource ConversationItemTemplate}"/>
            </GroupBox>

            <!-- Grupos -->
            <GroupBox Grid.Row="1">
                <GroupBox.Header>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <!-- nova coluna -->
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Grupos" FontWeight="Bold" VerticalAlignment="Center"/>
                        <Button Grid.Column="1" Content="＋" Width="24" Height="24" Margin="8,0,0,0"
            ToolTip="Criar novo grupo" Command="{Binding NewGroupCommand}"/>
                        <Button Grid.Column="2" Content="👤+" Width="32" Height="24" Margin="8,0,0,0"
            ToolTip="Adicionar membro ao grupo selecionado"
            Command="{Binding AddMemberToGroupCommand}"/>
                    </Grid>
                </GroupBox.Header>


                <ListBox x:Name="GroupsList"
         ItemsSource="{Binding Groups}"
         SelectedItem="{Binding SelectedGroup}"
         ItemTemplate="{StaticResource ConversationItemTemplate}">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="ContextMenu">
                                <Setter.Value>
                                    <ContextMenu>
                                        <MenuItem Header="Adicionar membro..."
                      Command="{Binding DataContext.AddMemberToGroupCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                      CommandParameter="{Binding}"/>
                                    </ContextMenu>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                </ListBox>

            </GroupBox>
        </Grid>

        <!-- ========== Área da conversa (coluna 1) ========== -->
        <Grid Grid.Column="1" Grid.Row="1" Margin="0,8,8,8">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Border BorderBrush="#DDD" BorderThickness="1" CornerRadius="8" Padding="4">
                <!-- ListBox já tem rolagem embutida -->
                <ListBox ItemsSource="{Binding Selected.Messages}"
             BorderThickness="0" Background="{x:Null}">
                    <!-- Alinha o CONTAINER (cada item) à esquerda/direita conforme IsMine -->
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="HorizontalContentAlignment"
                  Value="{Binding IsMine, Converter={StaticResource BoolToAlignment}}"/>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <!-- DataTemplate vem do App.xaml -->
                </ListBox>
            </Border>

            <!-- Composer -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Button Grid.Column="0" Content="📎" Width="40" Height="40" Margin="0,8,8,0"
                        Command="{Binding AttachCommand}"/>

                <TextBox Grid.Column="1" Margin="0,8,8,0" Height="40"
                         VerticalContentAlignment="Center"
                         Text="{Binding Compose, UpdateSourceTrigger=PropertyChanged}"/>

                <Button Grid.Column="2" Content="Enviar" Width="100" Height="40" Margin="0,8,0,0"
                        Command="{Binding SendCommand}"/>
            </Grid>
        </Grid>

        <!-- Rodapé: progresso -->
        <StackPanel Grid.ColumnSpan="2" Grid.Row="2" Orientation="Horizontal" Margin="8">
            <TextBlock Text="Progresso:" VerticalAlignment="Center"/>
            <ProgressBar Height="16" Width="260" Margin="8,0,0,0" Minimum="0" Maximum="1"
                         Value="{Binding ProgressText, Converter={StaticResource PercentToDouble}}"/>
            <TextBlock Text="{Binding ProgressText}" Margin="8,0,0,0" VerticalAlignment="Center"/>
        </StackPanel>
    </Grid>
</Window>
